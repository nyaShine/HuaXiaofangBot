适配帖子（删帖）
匿名投稿（低优先级）
修改问答（直接根据id覆盖），命令和添加问答一样（管理身份组）
selenium爬虫需要设置自动读取.exe
撤回并加入banWords（管理身份组）

[INFO]  (at_message_create_handler.py:25)at_message_create_handler      2023-06-11T00:33:46+08:00 513342943 一阳: <@!5964527605363577757> /测试
{'message': {'id': '08dfce98e4f799ba850110dffbe3f4011a1231343431313532313836373936393133343920801e280030b0acc7e60538a90540a90548c1c792a406', 'channel_id': '513342943', 'guild_id': '7873478628595631650', 'content': 'test', 'timestamp': '2023-06-11T00:24:33+08:00', 'author': {'id': '3411284862505116391', 'username': '一阳', 'bot': False}, 'member': {'roles': ['2'], 'joined_at': '2022-04-16T10:18:07+08:00'}}}

新增一个加屏蔽词的功能，调用方式为引用要屏蔽的消息，@机器人 /加屏蔽 ，函数名为add_to_banwords_apply_penalties(client, message)
首先读取message.member.roles，（即['4', '13732853', '12163054', '35']）中是否有config.yaml中config["adminRole"]中的
adminRole: 4,2,7,12168095,12202861,12202866
如果有则继续，没有则    await reply_with_log(message, 不是管理员，没有权限添加屏蔽词)



{'author': "{'id': '3411284862505116391', 'username': '一阳', 'bot': False, 'avatar': 'https://qqchannel-profile-1251316161.file.myqcloud.com/1684228280973451d813e54a2d?t=1684228281'}", 'content': '<@!5964527605363577757> /加屏蔽词', 'channel_id': '513342943', 'id': '08a28ccaa08ee38da26d10dffbe3f40138b20548a4cd92a406', 'guild_id': '7873478628595631650', 'member': "{'nick': '一阳', 'roles': ['4', '13732853', '12163054', '35'], 'joined_at': '2022-04-16T10:18:07+08:00'}", 'message_reference': "{'message_id': None}", 'mentions': "[{'id': '5964527605363577757', 'username': '华小纺Bot', 'bot': True, 'avatar': 'http://thirdqq.qlogo.cn/g?b=oidb&k=UnsK7pxxKd4mice9w0WsG1g&kti=ZISmSwAAAAA&s=0&t=1686050451'}]", 'attachments': '[]', 'seq': '690', 'seq_in_channel': '690', 'timestamp': '2023-06-11T00:36:52+08:00', 'event_id': 'AT_MESSAGE_CREATE:08ff0022-2578-40cd-9f3a-8ecda883d6d6'}


import re
from datetime import datetime, timedelta
import json

from botpy.errors import ServerError

from config import config
from utils.send_message_with_log import cross_channel_reply_with_log


class BanWordConfig:
    def __init__(self, id: int, enabled: bool, notify: bool, muteTime: int, deleteUser: bool, words: list):
        self.id = id
        self.enabled = enabled
        self.notify = notify
        self.muteTime = muteTime
        self.deleteUser = deleteUser
        self.words = words


def load_ban_words(filename: str) -> list[BanWordConfig]:
    ban_configs = []

    with open(filename, "r", encoding="utf-8") as f:
        data = json.load(f)

        for config in data["configurations"]:
            ban_configs.append(BanWordConfig(
                config["id"],
                config["enabled"],
                config["notify"],
                config["muteTime"],
                config["deleteUser"],
                config["words"]
            ))

    return ban_configs


ban_words_configs = load_ban_words("config/banWords.json")


def find_matching_configuration(message_content: str, ban_words_config: list[BanWordConfig]) -> BanWordConfig:
    for configuration in ban_words_config:
        if not configuration.enabled:
            continue
        for word in configuration.words:
            if re.search(word, message_content):
                return configuration
    return None


async def handle_ban_words(client, message):
    ban_config = find_matching_configuration(message.content, ban_words_configs)
    if ban_config is not None:
        await apply_configuration(client, message, ban_words_configs)


def find_matching_configuration(message_content, ban_words_config):
    for configuration in ban_words_config:
        if not configuration.enabled:
            continue
        for word in configuration.words:
            if re.search(word, message_content):
                return configuration
    return None


async def apply_configuration(client, message, ban_word_configs):
    warning_channel_id = config['warningChannel']
    ban_config = find_matching_configuration(message.content, ban_word_configs)
    if ban_config is not None:
        if ban_config.notify:
            now = datetime.now()
            if 23 <= now.hour or now.hour < 6:
                return
            actions = []
            if ban_config.muteTime > 0:
                actions.append(f'您将被禁言 {ban_config.muteTime} 秒')
            if ban_config.deleteUser:
                actions.append('您将被移出群组')

        if ban_config.muteTime > 0:
            mute_end_timestamp = int(datetime.timestamp(datetime.now() + timedelta(seconds=ban_config.muteTime)))
            try:
                await client.api.mute_member(guild_id=message.guild_id, user_id=message.author.id,
                                             mute_end_timestamp=mute_end_timestamp)
            except ServerError as e:
                if 'oidb rpc call failed' in str(e):
                    # 添加以下代码发送提醒
                    actions.append(f'无法禁言发送违禁词的成员')
                else:
                    raise e

            try:
                await client.api.recall_message(channel_id=message.channel_id, message_id=message.id, hidetip=False)
            except ServerError as e:
                if 'no permission to delete message' in str(e):
                    # 添加以下代码发送提醒
                    actions.append(f'无法删除包含违禁词的消息')
                else:
                    raise e

        if ban_config.deleteUser:
            try:
                await client.api.get_delete_member(
                    guild_id=message.guild_id,
                    user_id=message.author.id,
                    add_blacklist=False,
                    delete_history_msg_days=3
                )
            except ServerError as e:
                if 'no privilege remove member' in str(e):
                    actions.append('无法移除发送违禁词的成员')
                else:
                    raise e

    action_str = '，'.join(actions)
    content = f'您的消息中含有违禁词，请注意！处理方式：{action_str}'
    await cross_channel_reply_with_log(client, message, content, channel_id=warning_channel_id, at=True)



C:\Users\16936\.cache\selenium\chromedriver\win32\96.0.4664.45\chromedriver.exe
C:\Users\Administrator\.cache\selenium\chromedriver\win32\114.0.5735.90\chromedriver.exe

频道号：7873478628595631650

子频道列表：
ID: 12031971, 名称: 💰交易 | 综合-延
ID: 11505746, 名称: 🔊尚实 | 东华建议
ID: 12019371, 名称: 💰交易 | 综合-松-毕业季
ID: 433407763, 名称: 帖子测试
ID: 527350560, 名称: ⚠️提醒 | 管理日志
ID: 5597073, 名称: 🗺群聊 | 老乡群
ID: 11473998, 名称: 🏫答疑 | 你问我答（欢迎提问）
ID: 12018393, 名称: 🔊公告 | 镜月喇叭
ID: 12019824, 名称: 💳互助 | 失物召领处
ID: 5254916, 名称: 🍵聊天 | 镜月茶馆
ID: 5560483, 名称: 💬公告 | 讲座 晨跑 学分 活动
ID: 12019458, 名称: 🤝互助 | 代取代购-延
ID: 6820714, 名称: 📅日程 | 教务通知
ID: 11549205, 名称: 📎管理 | 频道事务
ID: 12906931, 名称: 🖼摄影 | 校园风光
ID: 6523011, 名称: 🤝互助 | 代取代购-松
ID: 11548245, 名称: 🔋交流 | 电瓶车充电
ID: 12000361, 名称: 🗒指引 | 频道帮助
ID: 12019417, 名称: 🚕交易 | 拼车租房
ID: 12558045, 名称: 东华大学教务处
ID: 5591358, 名称: 👥招新 | 社团 学生组织
ID: 12044876, 名称: 🔗链接 | 松江七校
ID: 12911030, 名称: 🏝迎新 | 镜月码头
ID: 15412993, 名称: 📁资料 | 共享（非交易）
ID: 32296510, 名称: 东华小助手（建议使用VPN）
ID: 5557817, 名称: ♥帖子 | 交友爱好
ID: 5717684, 名称: 📖学习 | 自律 换课 组队 问卷
ID: 12903828, 名称: 👥身份 | 获取权限和身份组
ID: 439202609, 名称: 💼兼职 | 勤工助学信息
ID: 513342943, 名称: 消息测试
ID: 10018041, 名称: 💴招聘 | 实习兼职
ID: 12066814, 名称: 💝志愿 | 志愿服务活动
ID: 5784699, 名称: 🔽长按订阅到QQ主页🔽
ID: 12158550, 名称: 📰公告 不用时折叠📰
ID: 12018769, 名称: 交易代取💰不用时折叠
ID: 5254923, 名称: 💕欢迎邀请同学室友💕
ID: 5254925, 名称: 频道管理
ID: 15403036, 名称: 链接
ID: 7158527, 名称: 归档（请忽略此分类）
ID: 5254926, 名称:

身份组列表：
ID: 4, 名称: 频道主, 人数: 1, 成员上限: 1
ID: 2, 名称: 超级管理员, 人数: 5, 成员上限: 50
ID: 7, 名称: 分组管理员, 人数: 0, 成员上限: 50
ID: 12168095, 名称: 管理员, 人数: 4, 成员上限: 80000
ID: 12202861, 名称: 巡查, 人数: 5, 成员上限: 80000
ID: 12202866, 名称: 运营团队, 人数: 4, 成员上限: 80000
ID: 5, 名称: 子频道管理员, 人数: 5, 成员上限: 50
ID: 12070926, 名称: 退休或荣誉成员, 人数: 1, 成员上限: 80000
ID: 12202869, 名称: 艺术家, 人数: 18, 成员上限: 80000
ID: 13732853, 名称: 已校园邮箱认证, 人数: 2, 成员上限: 80000
ID: 12209552, 名称: 学生组织, 人数: 70, 成员上限: 80000
ID: 12209554, 名称: 社团、运动队、艺术团, 人数: 67, 成员上限: 80000
ID: 12209557, 名称: 勤工助学或创新创业, 人数: 10, 成员上限: 80000
ID: 12422223, 名称: 校友, 人数: 0, 成员上限: 80000
ID: 12455854, 名称: 教职工, 人数: 0, 成员上限: 80000
ID: 12623338, 名称: 热心同学, 人数: 0, 成员上限: 80000
ID: 12163054, 名称: 松江校区, 人数: 2678, 成员上限: 80000
ID: 12163056, 名称: 延安路校区, 人数: 438, 成员上限: 80000
ID: 13073946, 名称: 机器人（全频道可见，可发言）, 人数: 3, 成员上限: 80000
ID: 6, 名称: 访客, 人数: 0, 成员上限: 80000
ID: 1, 名称: 普通成员, 人数: 0, 成员上限: 1000
