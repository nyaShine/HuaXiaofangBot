é€‚é…å¸–å­ï¼ˆåˆ å¸–ï¼‰
åŒ¿åæŠ•ç¨¿ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
ä¿®æ”¹é—®ç­”ï¼ˆç›´æ¥æ ¹æ®idè¦†ç›–ï¼‰ï¼Œå‘½ä»¤å’Œæ·»åŠ é—®ç­”ä¸€æ ·ï¼ˆç®¡ç†èº«ä»½ç»„ï¼‰
seleniumçˆ¬è™«éœ€è¦è®¾ç½®è‡ªåŠ¨è¯»å–.exe
æ’¤å›å¹¶åŠ å…¥banWordsï¼ˆç®¡ç†èº«ä»½ç»„ï¼‰

[INFO]  (at_message_create_handler.py:25)at_message_create_handler      2023-06-11T00:33:46+08:00 513342943 ä¸€é˜³: <@!5964527605363577757> /æµ‹è¯•
{'message': {'id': '08dfce98e4f799ba850110dffbe3f4011a1231343431313532313836373936393133343920801e280030b0acc7e60538a90540a90548c1c792a406', 'channel_id': '513342943', 'guild_id': '7873478628595631650', 'content': 'test', 'timestamp': '2023-06-11T00:24:33+08:00', 'author': {'id': '3411284862505116391', 'username': 'ä¸€é˜³', 'bot': False}, 'member': {'roles': ['2'], 'joined_at': '2022-04-16T10:18:07+08:00'}}}

æ–°å¢ä¸€ä¸ªåŠ å±è”½è¯çš„åŠŸèƒ½ï¼Œè°ƒç”¨æ–¹å¼ä¸ºå¼•ç”¨è¦å±è”½çš„æ¶ˆæ¯ï¼Œ@æœºå™¨äºº /åŠ å±è”½ ï¼Œå‡½æ•°åä¸ºadd_to_banwords_apply_penalties(client, message)
é¦–å…ˆè¯»å–message.member.rolesï¼Œï¼ˆå³['4', '13732853', '12163054', '35']ï¼‰ä¸­æ˜¯å¦æœ‰config.yamlä¸­config["adminRole"]ä¸­çš„
adminRole: 4,2,7,12168095,12202861,12202866
å¦‚æœæœ‰åˆ™ç»§ç»­ï¼Œæ²¡æœ‰åˆ™    await reply_with_log(message, ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ²¡æœ‰æƒé™æ·»åŠ å±è”½è¯)



{'author': "{'id': '3411284862505116391', 'username': 'ä¸€é˜³', 'bot': False, 'avatar': 'https://qqchannel-profile-1251316161.file.myqcloud.com/1684228280973451d813e54a2d?t=1684228281'}", 'content': '<@!5964527605363577757> /åŠ å±è”½è¯', 'channel_id': '513342943', 'id': '08a28ccaa08ee38da26d10dffbe3f40138b20548a4cd92a406', 'guild_id': '7873478628595631650', 'member': "{'nick': 'ä¸€é˜³', 'roles': ['4', '13732853', '12163054', '35'], 'joined_at': '2022-04-16T10:18:07+08:00'}", 'message_reference': "{'message_id': None}", 'mentions': "[{'id': '5964527605363577757', 'username': 'åå°çººBot', 'bot': True, 'avatar': 'http://thirdqq.qlogo.cn/g?b=oidb&k=UnsK7pxxKd4mice9w0WsG1g&kti=ZISmSwAAAAA&s=0&t=1686050451'}]", 'attachments': '[]', 'seq': '690', 'seq_in_channel': '690', 'timestamp': '2023-06-11T00:36:52+08:00', 'event_id': 'AT_MESSAGE_CREATE:08ff0022-2578-40cd-9f3a-8ecda883d6d6'}


import re
from datetime import datetime, timedelta
import json

from botpy.errors import ServerError

from config import config
from utils.send_message_with_log import cross_channel_reply_with_log


class BanWordConfig:
    def __init__(self, id: int, enabled: bool, notify: bool, muteTime: int, deleteUser: bool, words: list):
        self.id = id
        self.enabled = enabled
        self.notify = notify
        self.muteTime = muteTime
        self.deleteUser = deleteUser
        self.words = words


def load_ban_words(filename: str) -> list[BanWordConfig]:
    ban_configs = []

    with open(filename, "r", encoding="utf-8") as f:
        data = json.load(f)

        for config in data["configurations"]:
            ban_configs.append(BanWordConfig(
                config["id"],
                config["enabled"],
                config["notify"],
                config["muteTime"],
                config["deleteUser"],
                config["words"]
            ))

    return ban_configs


ban_words_configs = load_ban_words("config/banWords.json")


def find_matching_configuration(message_content: str, ban_words_config: list[BanWordConfig]) -> BanWordConfig:
    for configuration in ban_words_config:
        if not configuration.enabled:
            continue
        for word in configuration.words:
            if re.search(word, message_content):
                return configuration
    return None


async def handle_ban_words(client, message):
    ban_config = find_matching_configuration(message.content, ban_words_configs)
    if ban_config is not None:
        await apply_configuration(client, message, ban_words_configs)


def find_matching_configuration(message_content, ban_words_config):
    for configuration in ban_words_config:
        if not configuration.enabled:
            continue
        for word in configuration.words:
            if re.search(word, message_content):
                return configuration
    return None


async def apply_configuration(client, message, ban_word_configs):
    warning_channel_id = config['warningChannel']
    ban_config = find_matching_configuration(message.content, ban_word_configs)
    if ban_config is not None:
        if ban_config.notify:
            now = datetime.now()
            if 23 <= now.hour or now.hour < 6:
                return
            actions = []
            if ban_config.muteTime > 0:
                actions.append(f'æ‚¨å°†è¢«ç¦è¨€ {ban_config.muteTime} ç§’')
            if ban_config.deleteUser:
                actions.append('æ‚¨å°†è¢«ç§»å‡ºç¾¤ç»„')

        if ban_config.muteTime > 0:
            mute_end_timestamp = int(datetime.timestamp(datetime.now() + timedelta(seconds=ban_config.muteTime)))
            try:
                await client.api.mute_member(guild_id=message.guild_id, user_id=message.author.id,
                                             mute_end_timestamp=mute_end_timestamp)
            except ServerError as e:
                if 'oidb rpc call failed' in str(e):
                    # æ·»åŠ ä»¥ä¸‹ä»£ç å‘é€æé†’
                    actions.append(f'æ— æ³•ç¦è¨€å‘é€è¿ç¦è¯çš„æˆå‘˜')
                else:
                    raise e

            try:
                await client.api.recall_message(channel_id=message.channel_id, message_id=message.id, hidetip=False)
            except ServerError as e:
                if 'no permission to delete message' in str(e):
                    # æ·»åŠ ä»¥ä¸‹ä»£ç å‘é€æé†’
                    actions.append(f'æ— æ³•åˆ é™¤åŒ…å«è¿ç¦è¯çš„æ¶ˆæ¯')
                else:
                    raise e

        if ban_config.deleteUser:
            try:
                await client.api.get_delete_member(
                    guild_id=message.guild_id,
                    user_id=message.author.id,
                    add_blacklist=False,
                    delete_history_msg_days=3
                )
            except ServerError as e:
                if 'no privilege remove member' in str(e):
                    actions.append('æ— æ³•ç§»é™¤å‘é€è¿ç¦è¯çš„æˆå‘˜')
                else:
                    raise e

    action_str = 'ï¼Œ'.join(actions)
    content = f'æ‚¨çš„æ¶ˆæ¯ä¸­å«æœ‰è¿ç¦è¯ï¼Œè¯·æ³¨æ„ï¼å¤„ç†æ–¹å¼ï¼š{action_str}'
    await cross_channel_reply_with_log(client, message, content, channel_id=warning_channel_id, at=True)



C:\Users\16936\.cache\selenium\chromedriver\win32\96.0.4664.45\chromedriver.exe
C:\Users\Administrator\.cache\selenium\chromedriver\win32\114.0.5735.90\chromedriver.exe

é¢‘é“å·ï¼š7873478628595631650

å­é¢‘é“åˆ—è¡¨ï¼š
ID: 12031971, åç§°: ğŸ’°äº¤æ˜“ | ç»¼åˆ-å»¶
ID: 11505746, åç§°: ğŸ”Šå°šå® | ä¸œåå»ºè®®
ID: 12019371, åç§°: ğŸ’°äº¤æ˜“ | ç»¼åˆ-æ¾-æ¯•ä¸šå­£
ID: 433407763, åç§°: å¸–å­æµ‹è¯•
ID: 527350560, åç§°: âš ï¸æé†’ | ç®¡ç†æ—¥å¿—
ID: 5597073, åç§°: ğŸ—ºç¾¤èŠ | è€ä¹¡ç¾¤
ID: 11473998, åç§°: ğŸ«ç­”ç–‘ | ä½ é—®æˆ‘ç­”ï¼ˆæ¬¢è¿æé—®ï¼‰
ID: 12018393, åç§°: ğŸ”Šå…¬å‘Š | é•œæœˆå–‡å­
ID: 12019824, åç§°: ğŸ’³äº’åŠ© | å¤±ç‰©å¬é¢†å¤„
ID: 5254916, åç§°: ğŸµèŠå¤© | é•œæœˆèŒ¶é¦†
ID: 5560483, åç§°: ğŸ’¬å…¬å‘Š | è®²åº§ æ™¨è·‘ å­¦åˆ† æ´»åŠ¨
ID: 12019458, åç§°: ğŸ¤äº’åŠ© | ä»£å–ä»£è´­-å»¶
ID: 6820714, åç§°: ğŸ“…æ—¥ç¨‹ | æ•™åŠ¡é€šçŸ¥
ID: 11549205, åç§°: ğŸ“ç®¡ç† | é¢‘é“äº‹åŠ¡
ID: 12906931, åç§°: ğŸ–¼æ‘„å½± | æ ¡å›­é£å…‰
ID: 6523011, åç§°: ğŸ¤äº’åŠ© | ä»£å–ä»£è´­-æ¾
ID: 11548245, åç§°: ğŸ”‹äº¤æµ | ç”µç“¶è½¦å……ç”µ
ID: 12000361, åç§°: ğŸ—’æŒ‡å¼• | é¢‘é“å¸®åŠ©
ID: 12019417, åç§°: ğŸš•äº¤æ˜“ | æ‹¼è½¦ç§Ÿæˆ¿
ID: 12558045, åç§°: ä¸œåå¤§å­¦æ•™åŠ¡å¤„
ID: 5591358, åç§°: ğŸ‘¥æ‹›æ–° | ç¤¾å›¢ å­¦ç”Ÿç»„ç»‡
ID: 12044876, åç§°: ğŸ”—é“¾æ¥ | æ¾æ±Ÿä¸ƒæ ¡
ID: 12911030, åç§°: ğŸè¿æ–° | é•œæœˆç å¤´
ID: 15412993, åç§°: ğŸ“èµ„æ–™ | å…±äº«ï¼ˆéäº¤æ˜“ï¼‰
ID: 32296510, åç§°: ä¸œåå°åŠ©æ‰‹ï¼ˆå»ºè®®ä½¿ç”¨VPNï¼‰
ID: 5557817, åç§°: â™¥å¸–å­ | äº¤å‹çˆ±å¥½
ID: 5717684, åç§°: ğŸ“–å­¦ä¹  | è‡ªå¾‹ æ¢è¯¾ ç»„é˜Ÿ é—®å·
ID: 12903828, åç§°: ğŸ‘¥èº«ä»½ | è·å–æƒé™å’Œèº«ä»½ç»„
ID: 439202609, åç§°: ğŸ’¼å…¼èŒ | å‹¤å·¥åŠ©å­¦ä¿¡æ¯
ID: 513342943, åç§°: æ¶ˆæ¯æµ‹è¯•
ID: 10018041, åç§°: ğŸ’´æ‹›è˜ | å®ä¹ å…¼èŒ
ID: 12066814, åç§°: ğŸ’å¿—æ„¿ | å¿—æ„¿æœåŠ¡æ´»åŠ¨
ID: 5784699, åç§°: ğŸ”½é•¿æŒ‰è®¢é˜…åˆ°QQä¸»é¡µğŸ”½
ID: 12158550, åç§°: ğŸ“°å…¬å‘Š ä¸ç”¨æ—¶æŠ˜å ğŸ“°
ID: 12018769, åç§°: äº¤æ˜“ä»£å–ğŸ’°ä¸ç”¨æ—¶æŠ˜å 
ID: 5254923, åç§°: ğŸ’•æ¬¢è¿é‚€è¯·åŒå­¦å®¤å‹ğŸ’•
ID: 5254925, åç§°: é¢‘é“ç®¡ç†
ID: 15403036, åç§°: é“¾æ¥
ID: 7158527, åç§°: å½’æ¡£ï¼ˆè¯·å¿½ç•¥æ­¤åˆ†ç±»ï¼‰
ID: 5254926, åç§°:

èº«ä»½ç»„åˆ—è¡¨ï¼š
ID: 4, åç§°: é¢‘é“ä¸», äººæ•°: 1, æˆå‘˜ä¸Šé™: 1
ID: 2, åç§°: è¶…çº§ç®¡ç†å‘˜, äººæ•°: 5, æˆå‘˜ä¸Šé™: 50
ID: 7, åç§°: åˆ†ç»„ç®¡ç†å‘˜, äººæ•°: 0, æˆå‘˜ä¸Šé™: 50
ID: 12168095, åç§°: ç®¡ç†å‘˜, äººæ•°: 4, æˆå‘˜ä¸Šé™: 80000
ID: 12202861, åç§°: å·¡æŸ¥, äººæ•°: 5, æˆå‘˜ä¸Šé™: 80000
ID: 12202866, åç§°: è¿è¥å›¢é˜Ÿ, äººæ•°: 4, æˆå‘˜ä¸Šé™: 80000
ID: 5, åç§°: å­é¢‘é“ç®¡ç†å‘˜, äººæ•°: 5, æˆå‘˜ä¸Šé™: 50
ID: 12070926, åç§°: é€€ä¼‘æˆ–è£èª‰æˆå‘˜, äººæ•°: 1, æˆå‘˜ä¸Šé™: 80000
ID: 12202869, åç§°: è‰ºæœ¯å®¶, äººæ•°: 18, æˆå‘˜ä¸Šé™: 80000
ID: 13732853, åç§°: å·²æ ¡å›­é‚®ç®±è®¤è¯, äººæ•°: 2, æˆå‘˜ä¸Šé™: 80000
ID: 12209552, åç§°: å­¦ç”Ÿç»„ç»‡, äººæ•°: 70, æˆå‘˜ä¸Šé™: 80000
ID: 12209554, åç§°: ç¤¾å›¢ã€è¿åŠ¨é˜Ÿã€è‰ºæœ¯å›¢, äººæ•°: 67, æˆå‘˜ä¸Šé™: 80000
ID: 12209557, åç§°: å‹¤å·¥åŠ©å­¦æˆ–åˆ›æ–°åˆ›ä¸š, äººæ•°: 10, æˆå‘˜ä¸Šé™: 80000
ID: 12422223, åç§°: æ ¡å‹, äººæ•°: 0, æˆå‘˜ä¸Šé™: 80000
ID: 12455854, åç§°: æ•™èŒå·¥, äººæ•°: 0, æˆå‘˜ä¸Šé™: 80000
ID: 12623338, åç§°: çƒ­å¿ƒåŒå­¦, äººæ•°: 0, æˆå‘˜ä¸Šé™: 80000
ID: 12163054, åç§°: æ¾æ±Ÿæ ¡åŒº, äººæ•°: 2678, æˆå‘˜ä¸Šé™: 80000
ID: 12163056, åç§°: å»¶å®‰è·¯æ ¡åŒº, äººæ•°: 438, æˆå‘˜ä¸Šé™: 80000
ID: 13073946, åç§°: æœºå™¨äººï¼ˆå…¨é¢‘é“å¯è§ï¼Œå¯å‘è¨€ï¼‰, äººæ•°: 3, æˆå‘˜ä¸Šé™: 80000
ID: 6, åç§°: è®¿å®¢, äººæ•°: 0, æˆå‘˜ä¸Šé™: 80000
ID: 1, åç§°: æ™®é€šæˆå‘˜, äººæ•°: 0, æˆå‘˜ä¸Šé™: 1000
